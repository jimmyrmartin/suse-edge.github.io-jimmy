"use strict";(self.webpackChunksuse_edge_docs=self.webpackChunksuse_edge_docs||[]).push([[4759],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var a=n(7294);function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){s(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,s=function(e,t){if(null==e)return{};var n,a,s={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(s[n]=e[n]);return s}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(s[n]=e[n])}return s}var o=a.createContext({}),c=function(e){var t=a.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(o.Provider,{value:t},e.children)},d="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},h=a.forwardRef((function(e,t){var n=e.components,s=e.mdxType,i=e.originalType,o=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),d=c(n),h=s,m=d["".concat(o,".").concat(h)]||d[h]||p[h]||i;return n?a.createElement(m,r(r({ref:t},u),{},{components:n})):a.createElement(m,r({ref:t},u))}));function m(e,t){var n=arguments,s=t&&t.mdxType;if("string"==typeof e||s){var i=n.length,r=new Array(i);r[0]=h;var l={};for(var o in t)hasOwnProperty.call(t,o)&&(l[o]=t[o]);l.originalType=e,l[d]="string"==typeof e?e:s,r[1]=l;for(var c=2;c<i;c++)r[c]=n[c];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}h.displayName="MDXCreateElement"},9427:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>r,default:()=>p,frontMatter:()=>i,metadata:()=>l,toc:()=>c});var a=n(7462),s=(n(7294),n(3905));const i={sidebar_position:6,title:"NATS on K3s"},r="Intro",l={unversionedId:"quickstart/nats",id:"quickstart/nats",title:"NATS on K3s",description:"NATS is a connective technology built for the ever-increasingly hyper-connected world. It is a single technology that enables applications to securely communicate across any combination of cloud vendors, on-premise, edge, web and mobile devices. NATS consists of a family of open-source products that are tightly integrated but can be deployed easily and independently. NATS is being used globally by thousands of companies, spanning use cases including microservices, edge computing, mobile, and IoT, and can be used to augment or replace traditional messaging.",source:"@site/docs/quickstart/nats.md",sourceDirName:"quickstart",slug:"/quickstart/nats",permalink:"/docs/quickstart/nats",draft:!1,editUrl:"https://github.com/suse-edge/suse-edge.github.io/tree/main/docs/quickstart/nats.md",tags:[],version:"current",lastUpdatedBy:"Kristian Zhelyazkov",lastUpdatedAt:1691146626,formattedLastUpdatedAt:"Aug 4, 2023",sidebarPosition:6,frontMatter:{sidebar_position:6,title:"NATS on K3s"},sidebar:"docs",previous:{title:"MetalLB Service in front of the Kubernetes API server",permalink:"/docs/quickstart/metallb-kube-api"},next:{title:"RKE2 cluster with SELinux enabled",permalink:"/docs/quickstart/rke2-selinux"}},o={},c=[{value:"Architecture",id:"architecture",level:2},{value:"NATS Client Applications",id:"nats-client-applications",level:3},{value:"NATS Service Infrastructure",id:"nats-service-infrastructure",level:3},{value:"Simple messaging design",id:"simple-messaging-design",level:3},{value:"NATS JetStream",id:"nats-jetstream",level:3},{value:"Installation",id:"installation",level:2},{value:"Install NATS on top of K3s",id:"install-nats-on-top-of-k3s",level:3},{value:"Test the setup",id:"test-the-setup",level:4},{value:"Clean up",id:"clean-up",level:4},{value:"NATS as a backend for K3s",id:"nats-as-a-backend-for-k3s",level:3},{value:"Build K3s",id:"build-k3s",level:4},{value:"Install NATS CLI",id:"install-nats-cli",level:4},{value:"Run NATS as K3s backend",id:"run-nats-as-k3s-backend",level:4},{value:"Troubleshooting",id:"troubleshooting",level:4}],u={toc:c},d="wrapper";function p(e){let{components:t,...n}=e;return(0,s.kt)(d,(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"intro"},"Intro"),(0,s.kt)("p",null,(0,s.kt)("a",{parentName:"p",href:"https://nats.io/"},"NATS")," is a connective technology built for the ever-increasingly hyper-connected world. It is a single technology that enables applications to securely communicate across any combination of cloud vendors, on-premise, edge, web and mobile devices. NATS consists of a family of open-source products that are tightly integrated but can be deployed easily and independently. NATS is being used globally by thousands of companies, spanning use cases including microservices, edge computing, mobile, and IoT, and can be used to augment or replace traditional messaging."),(0,s.kt)("h2",{id:"architecture"},"Architecture"),(0,s.kt)("p",null,"NATS is an infrastructure that allows data exchange between applications in the form of messages."),(0,s.kt)("h3",{id:"nats-client-applications"},"NATS Client Applications"),(0,s.kt)("p",null,"NATS client libraries can be used to allow the applications to publish, subscribe, request, and reply between different instances.\nThese applications are generally referred to as ",(0,s.kt)("inlineCode",{parentName:"p"},"client applications"),"."),(0,s.kt)("h3",{id:"nats-service-infrastructure"},"NATS Service Infrastructure"),(0,s.kt)("p",null,"The NATS services are provided by one or more NATS server processes that are configured to interconnect with each other and provide a NATS service infrastructure. The NATS service infrastructure can scale from a single NATS server process running on an end device to a public global super-cluster of many clusters spanning all major cloud providers and all regions of the world."),(0,s.kt)("h3",{id:"simple-messaging-design"},"Simple messaging design"),(0,s.kt)("p",null,"NATS makes it easy for applications to communicate by sending and receiving messages. These messages are addressed and identified by subject strings and do not depend on network location.\nData is encoded and framed as a message and sent by a publisher. The message is received, decoded, and processed by one or more subscribers."),(0,s.kt)("h3",{id:"nats-jetstream"},"NATS JetStream"),(0,s.kt)("p",null,"NATS has a built-in distributed persistence system called JetStream.\nJetStream was created to solve the problems identified with streaming in technology today - complexity, fragility, and a lack of scalability. JetStream also solves the problem with the coupling of the publisher and the subscriber (the subscribers need to be up and running to receive the message when it is published).\nMore information about NATS JetStream can be found ",(0,s.kt)("a",{parentName:"p",href:"https://docs.nats.io/nats-concepts/jetstream"},"here"),"."),(0,s.kt)("h2",{id:"installation"},"Installation"),(0,s.kt)("h3",{id:"install-nats-on-top-of-k3s"},"Install NATS on top of K3s"),(0,s.kt)("p",null,"NATS is built for multiple architectures, so it can easily be installed on the ",(0,s.kt)("a",{parentName:"p",href:"https://suse-edge.github.io/docs/quickstart/k3s-on-slemicro"},"the K3s on SLE Micro Setup"),"."),(0,s.kt)("p",null,"Let's create a values file that will be used for overwriting the default values of NATS."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"cat > values.yaml <<EOF\ncluster:\n  # Enable the HA setup of the NATS\n  enabled: true\n  replicas: 3\n\nnats:\n  jetstream:\n    # Enable JetStream\n    enabled: true\n\n    memStorage:\n      enabled: true\n      size: 2Gi\n\n    fileStorage:\n      enabled: true\n      size: 1Gi\n      storageDirectory: /data/\nEOF\n")),(0,s.kt)("p",null,"Now let's install NATS via helm:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-shell"},"helm repo add nats https://nats-io.github.io/k8s/helm/charts/\nhelm install nats nats/nats --namespace nats --values values.yaml --create-namespace\n")),(0,s.kt)("p",null,"With the ",(0,s.kt)("inlineCode",{parentName:"p"},"values.yaml")," file above, the following components will be in the ",(0,s.kt)("inlineCode",{parentName:"p"},"nats")," namespace:"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"HA version of NATS Statefulset containing 3 containers: NATS server + Config reloader and Metrics sidecars."),(0,s.kt)("li",{parentName:"ol"},"NATS box container which comes with a set of ",(0,s.kt)("inlineCode",{parentName:"li"},"NATS")," utilities that can be used to verify the setup."),(0,s.kt)("li",{parentName:"ol"},"JetStream Key-Value backend also will be enabled which comes with ",(0,s.kt)("inlineCode",{parentName:"li"},"PVCs")," bounded to the pods.")),(0,s.kt)("h4",{id:"test-the-setup"},"Test the setup"),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"kubectl exec -n nats -it deployment/nats-box -- /bin/sh -l")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"# Create a subscription for the test subject\nnats sub test &\n# Send a message to the test subject\nnats pub test hi\n")),(0,s.kt)("h4",{id:"clean-up"},"Clean up"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"helm -n nats uninstall nats\nrm values.yaml\n")),(0,s.kt)("h3",{id:"nats-as-a-backend-for-k3s"},"NATS as a backend for K3s"),(0,s.kt)("p",null,"One component K3s leverages is ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/k3s-io/kine"},"KINE"),", which is a shim enabling the replacement of etcd with alternate storage backends originally targeting relational databases.\nAs JetStream provides a Key Value API, this makes it possible to have NATS as a backend for the K3s cluster."),(0,s.kt)("p",null,"There is already merged PR which makes the built-in NATS in K3s straight-forward but the change is still ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/k3s-io/k3s/issues/7410#issue-1692989394"},"not included")," in the K3s releases."),(0,s.kt)("p",null,"For this reason, the K3s binary should be built manually."),(0,s.kt)("p",null,"In this tutorial, ",(0,s.kt)("a",{parentName:"p",href:"https://suse-edge.github.io/docs/quickstart/slemicro-utm-aarch64"},"SLE Micro on OSX on Apple Silicon (UTM)")," VM will be used."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"NOTE:")," Run the commands bellow on the OSX PC."),(0,s.kt)("h4",{id:"build-k3s"},"Build K3s"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"git clone --depth 1 https://github.com/k3s-io/k3s.git && cd k3s\n\n# The following command will add `nats` in the build tags which will enable the NATS built-in feature in K3s\nsed -i '' 's/TAGS=\"ctrd/TAGS=\"nats ctrd/g' scripts/build\n\nmake local\n\n# Replace <node-ip> with the actual IP of the node where the K3s will be started\nexport NODE_IP=<node-ip>\nsudo scp dist/artifacts/k3s-arm64 ${NODE_IP}:/usr/local/bin/k3s\n")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"NOTE:")," Locally building K3s requires the buildx Docker CLI plugin.\nIt can be ",(0,s.kt)("a",{parentName:"p",href:"https://github.com/docker/buildx#manual-download"},"manually installed")," if ",(0,s.kt)("inlineCode",{parentName:"p"},"$ make local")," fails."),(0,s.kt)("h4",{id:"install-nats-cli"},"Install NATS CLI"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},'TMPDIR=$(mktemp -d)\nnats_version="nats-0.0.35-linux-arm64"\ncurl -o "${TMPDIR}/nats.zip" -sfL https://github.com/nats-io/natscli/releases/download/v0.0.35/${nats_version}.zip\nunzip "${TMPDIR}/nats.zip" -d "${TMPDIR}"\n\nsudo scp ${TMPDIR}/${nats_version}/nats ${NODE_IP}:/usr/local/bin/nats\nrm -rf ${TMPDIR}\n')),(0,s.kt)("h4",{id:"run-nats-as-k3s-backend"},"Run NATS as K3s backend"),(0,s.kt)("p",null,"Let's ssh on the node and run the K3s with the ",(0,s.kt)("inlineCode",{parentName:"p"},"--datastore-endpoint")," flag pointing to ",(0,s.kt)("inlineCode",{parentName:"p"},"nats"),"."),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"NOTE:")," The command below will start K3s as a foreground process, so the logs can be easily followed to see if there are any issues.\nIf you want to not block the current terminal a ",(0,s.kt)("inlineCode",{parentName:"p"},"&")," flag could be added before the command to start it as a background process."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"k3s server  --datastore-endpoint=nats://")),(0,s.kt)("p",null,(0,s.kt)("strong",{parentName:"p"},"NOTE:")," For making the K3s server with the NATS backend permanent on your ",(0,s.kt)("inlineCode",{parentName:"p"},"slemicro")," VM, the script below can be run, which will create a ",(0,s.kt)("inlineCode",{parentName:"p"},"systemd")," service with the needed configurations."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},'export INSTALL_K3S_SKIP_START=false\nexport INSTALL_K3S_SKIP_DOWNLOAD=true\n\ncurl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="server --datastore-endpoint=nats://"  sh -\n')),(0,s.kt)("h4",{id:"troubleshooting"},"Troubleshooting"),(0,s.kt)("p",null,"The following commands can be run on the node to verify that everything with the stream is working properly:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-sh"},"nats str report -a\nnats str view -a\n")))}p.isMDXComponent=!0}}]);